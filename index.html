<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>HYROX SLOT RADAR</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #0f1115; --card: #161920; --border: #2a2f3a;
      --accent: #fbbf24; --text: #fff; --text-dim: #9ca3af;
      --red: #ef4444; --green: #10b981;
      --hover: #222;
    }
    body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 60px; }

    /* HEADER */
    header {
      background: #000; border-bottom: 1px solid var(--border); padding: 15px 20px;
      position: sticky; top: 0; z-index: 50;
    }
    .header-inner { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .brand { font-family: 'Teko', sans-serif; font-size: 28px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    .brand span { color: var(--accent); }
    .version { font-size: 11px; color: #444; font-family: 'Inter', sans-serif; letter-spacing: 0;}

    /* TABS */
    .tabs { display: flex; gap: 20px; margin-top: 20px; border-bottom: 1px solid var(--border); padding-bottom: 0; }
    .tab-btn {
      background: transparent; border: none; color: var(--text-dim); 
      font-size: 15px; font-weight: 600; padding: 10px 5px; cursor: pointer;
      border-bottom: 3px solid transparent; transition: 0.3s;
    }
    .tab-btn:hover { color: #fff; }
    .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

    /* MAIN CONTAINER */
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

    /* --- SEARCH BOX STYLES --- */
    .top-bar { margin-bottom: 20px; display: flex; gap: 15px; align-items: flex-start; flex-wrap: wrap; }
    
    .search-wrapper { position: relative; min-width: 300px; flex: 1; }
    .search-input {
      width: 100%; background: #222; border: 1px solid var(--border); color: #fff;
      padding: 12px 15px; border-radius: 6px; font-size: 14px; box-sizing: border-box;
      transition: 0.2s;
    }
    .search-input:focus { outline: none; border-color: var(--accent); background: #1a1d24; }
    
    .search-results {
      position: absolute; top: 100%; left: 0; right: 0;
      background: #1a1d24; border: 1px solid var(--border); border-radius: 6px;
      max-height: 300px; overflow-y: auto; z-index: 100; margin-top: 5px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.5); display: none;
    }
    .search-results.show { display: block; }
    
    .result-item {
      padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
    }
    .result-item:last-child { border-bottom: none; }
    .result-item:hover { background: var(--hover); }
    .ri-name { font-weight: 600; color: #fff; }
    .ri-date { font-size: 12px; color: var(--accent); background: rgba(251, 191, 36, 0.1); padding: 2px 6px; border-radius: 4px; }

    /* FILTER BUTTONS */
    .filter-wrapper { display: flex; flex-direction: column; gap:8px;}
    .filter-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px;}
    .filter-group { display: flex; gap: 5px; flex-wrap: wrap; }
    .filter-btn { 
      background: #222; border: 1px solid var(--border); color: #aaa; padding: 8px 12px; 
      border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; transition: 0.2s;
    }
    .filter-btn:hover { border-color: #555; color: #fff; }
    .filter-btn.active { background: var(--accent); color: #000; border-color: var(--accent); }

    /* SELECTED EVENT INFO */
    .selected-event-header {
      background: var(--card); border: 1px solid var(--border); padding: 15px; 
      border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between;
    }
    .seh-title { font-size: 20px; font-weight: 700; color: var(--accent); font-family: 'Teko', sans-serif; letter-spacing: 0.5px; }
    .seh-date { font-size: 14px; color: var(--text-dim); display: flex; align-items: center; gap: 5px;}

    /* DROPDOWN (Category) */
    select.custom-select {
      background: #222; color: #fff; border: 1px solid var(--border); padding: 10px 15px;
      border-radius: 6px; font-size: 14px; cursor: pointer; min-width: 250px;
    }
    select.custom-select:focus { outline: none; border-color: var(--accent); }

    /* CHARTS */
    .chart-section { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .chart-header { font-size: 16px; font-weight: 700; margin-bottom: 15px; display: flex; justify-content: space-between; }
    .chart-box { position: relative; height: 350px; width: 100%; }

    /* GLOBAL LIST TABLE */
    .global-list { display: flex; flex-direction: column; gap: 10px; }
    .global-item { 
      background: var(--card); border: 1px solid var(--border); padding: 15px; border-radius: 8px;
      display: flex; justify-content: space-between; align-items: center; transition: 0.2s;
    }
    .global-item:hover { border-color: var(--text-dim); }
    .gi-name { font-weight: 600; font-size: 16px; }
    .gi-date { font-size: 13px; color: var(--accent); margin-bottom: 4px; font-weight: 600;}
    .gi-update { font-size: 11px; color: var(--text-dim); }
    .gi-stock { text-align: right; }
    .gi-val { font-family: 'Teko', sans-serif; font-size: 24px; font-weight: 600; }
    .gi-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; }
    .stock-green { color: var(--green); }
    .stock-red { color: var(--red); }
    .gi-link { text-decoration: none; color: var(--text); display: block; width: 100%;}

    /* UTILS */
    .hidden { display: none !important; }
    #loader { text-align: center; padding: 50px; color: var(--text-dim); }
    .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s infinite; margin: 0 auto 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }

  </style>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="brand">HYROX <span>SLOT RADAR</span> <span class="version">v3.0</span></div>
  </div>
  <div class="header-inner">
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('tab-event')">City Analysis</button>
      <button class="tab-btn" onclick="switchTab('tab-category')">Category Finder</button>
    </div>
  </div>
</header>

<div class="container">

  <div id="tab-event" class="tab-content">
    
    <div class="top-bar">
      <div class="search-wrapper">
        <div class="filter-label" style="margin-bottom:5px;">SELECT EVENT</div>
        <input type="text" id="eventSearch" class="search-input" placeholder="Search city (e.g. London)..." autocomplete="off">
        <div id="searchResults" class="search-results"></div>
      </div>

      <div class="filter-wrapper">
        <div class="filter-label">FILTERS</div>
        <div class="filter-group">
          <button class="filter-btn active" onclick="setEventFilter('ALL', this)">ALL</button>
          <button class="filter-btn" onclick="setEventFilter('MEN_OPEN', this)">MEN OPEN</button>
          <button class="filter-btn" onclick="setEventFilter('MEN_PRO', this)">MEN PRO</button>
          <button class="filter-btn" onclick="setEventFilter('WOMEN_OPEN', this)">WOMEN OPEN</button>
          <button class="filter-btn" onclick="setEventFilter('WOMEN_PRO', this)">WOMEN PRO</button>
        </div>
        <div class="filter-group">
            <button class="filter-btn" onclick="setEventFilter('DOUBLES_MEN', this)">DBL MEN</button>
            <button class="filter-btn" onclick="setEventFilter('DOUBLES_WOMEN', this)">DBL WOMEN</button>
            <button class="filter-btn" onclick="setEventFilter('DOUBLES_MIXED', this)">DBL MIXED</button>
        </div>
      </div>
    </div>

    <div id="selectedEventInfo" class="selected-event-header hidden">
      <div>
        <div class="seh-title" id="sehName">Select an Event</div>
        <div class="seh-date">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          <span id="sehDate">...</span>
        </div>
      </div>
      <div><a href="#" id="sehLink" target="_blank" class="filter-btn active" style="text-decoration:none;">Go to Shop â†—</a></div>
    </div>

    <div id="eventLoader" class="hidden"><div class="spinner"></div>Loading Data...</div>

    <div id="eventDashboard" class="hidden">
      <div class="chart-section">
        <div class="chart-header">
            <span>ðŸ“ˆ Stock Trend (History)</span>
            <span style="font-size:12px; color:#666; font-weight:400;" id="chartSubtitle">(All Categories)</span>
        </div>
        <div class="chart-box"><canvas id="chartHistory"></canvas></div>
      </div>
      <div class="chart-section">
        <div class="chart-header">ðŸ“Š Current Ticket Distribution</div>
        <div class="chart-box"><canvas id="chartCurrent"></canvas></div>
      </div>
    </div>

  </div>

  <div id="tab-category" class="tab-content hidden">
    
    <div class="top-bar" style="background: #222; padding: 20px; border-radius: 8px; border: 1px solid var(--accent);">
      <div style="flex:1;">
        <label style="display:block; color:var(--accent); font-size:12px; margin-bottom:5px; font-weight:600;">SELECT CATEGORY</label>
        <select id="categorySelector" class="custom-select" style="width:100%; border-color:var(--accent);" onchange="loadGlobalData()">
          <option disabled selected>Choose a category...</option>
        </select>
      </div>
    </div>

    <div id="globalLoader" class="hidden"><div class="spinner"></div>Scanning Global Events...</div>

    <div id="globalResults" class="global-list">
      </div>

  </div>

</div>

<script>
/* --- CONFIG & STATE --- */
const CONFIG = {
  eventsFile: "events.json",
  categoriesFile: "yaristurleri.json",
  dataDir: "data"
};

let EVENTS = [];
let CATEGORIES = [];
let EVENT_DATA = null;
let EVENT_FILTER = 'ALL';
let CHARTS = { history: null, current: null };

/* --- INITIALIZATION --- */
async function init() {
  try {
    const [evRes, catRes] = await Promise.all([
      fetch(`${CONFIG.eventsFile}?t=${Date.now()}`),
      fetch(`${CONFIG.categoriesFile}?t=${Date.now()}`)
    ]);

    if(evRes.ok) EVENTS = await evRes.json();
    if(catRes.ok) CATEGORIES = await catRes.json();

    // SORT EVENTS BY DATE (Oldest to Newest)
    EVENTS.sort((a, b) => parseDate(a.startDate) - parseDate(b.startDate));

    setupSearch();
    populateCategoryDropdown();

    // Auto-select first upcoming event if available
    if(EVENTS.length > 0) {
      selectEvent(EVENTS[0]);
    }

  } catch (e) {
    alert("Initialization Error: " + e.message);
  }
}

function parseDate(dateStr) {
  if(!dateStr) return new Date(8640000000000000); 
  const parts = dateStr.split('.');
  return new Date(parts[2], parts[1] - 1, parts[0]);
}

/* --- SEARCH & SELECTION LOGIC --- */
function setupSearch() {
  const input = document.getElementById('eventSearch');
  const resultsBox = document.getElementById('searchResults');

  const renderList = (list) => {
    resultsBox.innerHTML = '';
    if(list.length === 0) {
      resultsBox.innerHTML = '<div style="padding:10px; color:#aaa;">No events found.</div>';
      return;
    }
    list.forEach(evt => {
      const div = document.createElement('div');
      div.className = 'result-item';
      div.innerHTML = `
        <span class="ri-name">${evt.name}</span>
        <span class="ri-date">${evt.startDate || 'TBA'}</span>
      `;
      div.onclick = () => {
        selectEvent(evt);
        input.value = evt.name;
        resultsBox.classList.remove('show');
      };
      resultsBox.appendChild(div);
    });
  };

  input.addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    const filtered = EVENTS.filter(evt => evt.name.toLowerCase().includes(term));
    renderList(filtered);
    resultsBox.classList.add('show');
  });

  input.addEventListener('focus', () => {
    renderList(EVENTS); 
    resultsBox.classList.add('show');
  });

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.search-wrapper')) {
      resultsBox.classList.remove('show');
    }
  });
}

function selectEvent(evt) {
  const infoBox = document.getElementById('selectedEventInfo');
  infoBox.classList.remove('hidden');
  document.getElementById('sehName').textContent = evt.name;
  document.getElementById('sehDate').textContent = evt.startDate || 'Date TBA';
  document.getElementById('sehLink').href = evt.url;
  document.getElementById('eventSearch').value = evt.name;

  loadEventData(evt.id);
}

function populateCategoryDropdown() {
  const catSel = document.getElementById('categorySelector');
  CATEGORIES.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.name;
    catSel.appendChild(opt);
  });
}

/* --- TAB MANAGEMENT --- */
window.switchTab = (tabId) => {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  
  document.getElementById(tabId).classList.remove('hidden');
  const btns = document.querySelectorAll('.tab-btn');
  if(tabId === 'tab-event') btns[0].classList.add('active');
  else btns[1].classList.add('active');
};


/* =================================================================
   LOGIC FOR TAB 1: EVENT ANALYZER
   ================================================================= */
async function loadEventData(eventId) {
  if(!eventId) return;

  const loader = document.getElementById('eventLoader');
  const dash = document.getElementById('eventDashboard');
  
  loader.classList.remove('hidden');
  dash.classList.add('hidden');

  try {
    const res = await fetch(`${CONFIG.dataDir}/${eventId}.json?t=${Date.now()}`);
    if(!res.ok) throw new Error("Data file not found.");
    const json = await res.json();
    
    // Sort and Filter Data (Remove Relay/Charity immediately)
    EVENT_DATA = json.history.map(h => ({
      date: h.date,
      tickets: h.data.tickets.filter(t => !isExcluded(t.ticket))
    })).sort((a,b) => new Date(a.date) - new Date(b.date));

    renderEventCharts();
    loader.classList.add('hidden');
    dash.classList.remove('hidden');

  } catch (e) {
    loader.innerHTML = `No tracking data found yet. Scraper will run soon.`;
  }
}

// Global Exclusion Logic
function isExcluded(ticketName) {
    const n = ticketName.toUpperCase();
    return n.includes('RELAY') || n.includes('CHARITY') || n.includes('SPECTATOR') || n.includes('ADAPTIVE');
}

window.setEventFilter = (filter, btn) => {
  EVENT_FILTER = filter;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderEventCharts();
}

function renderEventCharts() {
  if(!EVENT_DATA) return;

  const ctxH = document.getElementById('chartHistory').getContext('2d');
  const labels = EVENT_DATA.map(d => d.date.split('-').slice(1).reverse().join('.')); // 07.02
  let datasets = [];

  // Define Filter Rules
  // N = Ticket Name (UpperCase)
  const filters = {
    'ALL': () => true,
    'MEN_OPEN': (n) => n.includes('MEN') && !n.includes('PRO') && !n.includes('DOUBLES'),
    'MEN_PRO': (n) => n.includes('MEN') && n.includes('PRO'),
    'WOMEN_OPEN': (n) => n.includes('WOMEN') && !n.includes('PRO') && !n.includes('DOUBLES'),
    'WOMEN_PRO': (n) => n.includes('WOMEN') && n.includes('PRO'),
    'DOUBLES_MEN': (n) => n.includes('DOUBLES') && n.includes('MEN') && !n.includes('MIXED'),
    'DOUBLES_WOMEN': (n) => n.includes('DOUBLES') && n.includes('WOMEN') && !n.includes('MIXED'),
    'DOUBLES_MIXED': (n) => n.includes('DOUBLES') && n.includes('MIXED')
  };

  const currentCheck = filters[EVENT_FILTER] || filters['ALL'];

  // --- CHART 1: History (Stock Over Time) ---
  
  if (EVENT_FILTER === 'ALL') {
      // Show Aggregates
      const groups = [
          { name: 'Men Open', color: '#3b82f6', rule: filters['MEN_OPEN'] },
          { name: 'Men Pro', color: '#2563eb', rule: filters['MEN_PRO'] },
          { name: 'Women Open', color: '#ec4899', rule: filters['WOMEN_OPEN'] },
          { name: 'Women Pro', color: '#db2777', rule: filters['WOMEN_PRO'] },
          { name: 'Dbl Men', color: '#fbbf24', rule: filters['DOUBLES_MEN'] },
          { name: 'Dbl Women', color: '#f59e0b', rule: filters['DOUBLES_WOMEN'] },
          { name: 'Dbl Mixed', color: '#d97706', rule: filters['DOUBLES_MIXED'] }
      ];

      datasets = groups.map(g => ({
          label: g.name,
          borderColor: g.color,
          backgroundColor: g.color,
          tension: 0.3,
          pointRadius: 2,
          borderWidth: 2,
          data: EVENT_DATA.map(day => day.tickets.filter(t => g.rule(t.ticket.toUpperCase())).reduce((s, t) => s + t.stock, 0))
      }));

  } else {
      // Show Specific Ticket Types within the Category
      // Find all unique ticket names matching the filter
      const uniqueNames = new Set();
      EVENT_DATA.forEach(d => {
          d.tickets.forEach(t => {
              if(currentCheck(t.ticket.toUpperCase())) uniqueNames.add(t.ticket);
          });
      });

      const palette = ['#fbbf24', '#3b82f6', '#ef4444', '#10b981', '#f97316', '#8b5cf6'];
      let cIdx = 0;

      uniqueNames.forEach(uName => {
        const dName = uName.replace(/HYROX /gi, '').trim();
        datasets.push({
            label: dName,
            borderColor: palette[cIdx % palette.length],
            backgroundColor: palette[cIdx % palette.length],
            tension: 0.3,
            data: EVENT_DATA.map(day => {
                const found = day.tickets.find(t => t.ticket === uName);
                return found ? found.stock : null;
            })
        });
        cIdx++;
      });
  }

  // Draw History Chart
  if(CHARTS.history) CHARTS.history.destroy();
  CHARTS.history = new Chart(ctxH, {
    type: 'line',
    data: { labels, datasets },
    options: { 
      responsive: true, maintainAspectRatio: false, 
      scales: { 
          y: { beginAtZero: true, grid: { color: '#2a2f3a' }, ticks: { color: '#9ca3af' } },
          x: { grid: { color: '#2a2f3a' }, ticks: { color: '#9ca3af' } }
      },
      plugins: { 
          legend: { labels: { color: '#fff', font:{size:11} } },
          tooltip: { mode: 'index', intersect: false }
      }
    }
  });

  // --- CHART 2: Current Bar ---
  const latest = EVENT_DATA[EVENT_DATA.length - 1];
  let currentTickets = latest.tickets.filter(t => currentCheck(t.ticket.toUpperCase()));
  
  currentTickets.sort((a,b) => b.stock - a.stock);

  const ctxC = document.getElementById('chartCurrent').getContext('2d');
  if(CHARTS.current) CHARTS.current.destroy();
  CHARTS.current = new Chart(ctxC, {
    type: 'bar',
    data: {
      labels: currentTickets.map(t => t.ticket.replace(/HYROX /gi,'').trim()),
      datasets: [{
        label: 'Tickets Available',
        data: currentTickets.map(t => t.stock),
        backgroundColor: currentTickets.map(t => t.stock < 20 ? '#ef4444' : '#10b981')
      }]
    },
    options: { 
        responsive: true, maintainAspectRatio: false, indexAxis: 'y',
        scales: { 
            x: { ticks: { color: '#9ca3af' }, grid: { color: '#2a2f3a' } }, 
            y: { ticks: { color: '#fff' }, grid: { display: false } } 
        }
    }
  });
}


/* =================================================================
   LOGIC FOR TAB 2: GLOBAL CATEGORY SEARCH
   ================================================================= */
async function loadGlobalData() {
  const catId = document.getElementById('categorySelector').value;
  const categoryRule = CATEGORIES.find(c => c.id === catId);
  if(!categoryRule) return;

  const loader = document.getElementById('globalLoader');
  const resultsDiv = document.getElementById('globalResults');
  loader.classList.remove('hidden');
  resultsDiv.innerHTML = '';

  try {
    const promises = EVENTS.map(evt => 
      fetch(`${CONFIG.dataDir}/${evt.id}.json?t=${Date.now()}`)
        .then(res => res.ok ? res.json() : null)
        .then(data => ({ event: evt, data: data }))
        .catch(err => ({ event: evt, data: null }))
    );

    const results = await Promise.all(promises);
    const validResults = [];

    results.forEach(item => {
      if(!item.data || !item.data.history || item.data.history.length === 0) return;
      const history = item.data.history;
      const latest = history[history.length - 1];
      let totalStock = 0;

      latest.data.tickets.forEach(t => {
        if(isExcluded(t.ticket)) return; // Global exclude check
        
        const name = t.ticket.toUpperCase();
        const matchesInclude = categoryRule.include.every(key => name.includes(key));
        const matchesExclude = categoryRule.exclude.some(key => name.includes(key));

        if (matchesInclude && !matchesExclude) {
          totalStock += t.stock;
        }
      });

      if (totalStock > 0) {
        validResults.push({
          eventName: item.event.name,
          eventDate: item.event.startDate,
          url: item.event.url,
          stock: totalStock,
          lastUpdate: latest.date
        });
      }
    });

    validResults.sort((a,b) => parseDate(a.eventDate) - parseDate(b.eventDate));
    loader.classList.add('hidden');
    renderGlobalResults(validResults, categoryRule.name);

  } catch (e) {
    loader.innerHTML = "Error occurred during search.";
  }
}

function renderGlobalResults(list, catName) {
  const container = document.getElementById('globalResults');
  if(list.length === 0) {
    container.innerHTML = `<div style="text-align:center; padding:20px; color:#aaa;">No tickets found for <strong>${catName}</strong>.</div>`;
    return;
  }

  list.forEach(item => {
    const el = document.createElement('a');
    el.className = 'global-item gi-link';
    el.href = item.url;
    el.target = "_blank"; 
    const stockClass = item.stock < 50 ? 'stock-red' : 'stock-green';

    el.innerHTML = `
      <div>
        <div class="gi-date">${item.eventDate}</div>
        <div class="gi-name">${item.eventName}</div>
        <div class="gi-update">Data from: ${item.lastUpdate}</div>
      </div>
      <div class="gi-stock">
        <div class="gi-label">Available</div>
        <div class="gi-val ${stockClass}">${item.stock}</div>
      </div>
    `;
    container.appendChild(el);
  });
}

init();

</script>
</body>
</html>
