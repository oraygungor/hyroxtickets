<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>HYROX SLOT RADAR</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #09090b; --card: #18181b; --border: #27272a;
      --accent: #facc15; --text: #fafafa; --text-dim: #a1a1aa;
      --red: #ef4444; --green: #10b981; --orange: #f97316; --blue: #3b82f6;
      --hover: #27272a;
      --font-heading: 'Teko', sans-serif;
      --font-body: 'Inter', sans-serif;
    }
    
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg); color: var(--text); font-family: var(--font-body); margin: 0; padding-bottom: 80px; }

    /* --- HEADER --- */
    header {
      background: rgba(9, 9, 11, 0.85); backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 100;
      padding: 15px 20px 0 20px;
    }
    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; max-width: 1200px; margin: 0 auto 15px; }
    .brand { font-family: var(--font-heading); font-size: 32px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; line-height: 1; }
    .brand span { color: var(--accent); }
    .version { font-size: 10px; color: var(--text-dim); font-family: var(--font-body); vertical-align: middle; background: #222; padding: 2px 6px; border-radius: 4px; margin-left: 5px; letter-spacing: 0; }

    /* --- TABS --- */
    .tabs { display: flex; gap: 20px; max-width: 1200px; margin: 0 auto; }
    .tab-btn {
      background: transparent; border: none; color: var(--text-dim);
      font-size: 14px; font-weight: 600; padding: 10px 0; cursor: pointer;
      border-bottom: 2px solid transparent; transition: 0.3s; margin-bottom: -1px;
    }
    .tab-btn.active { color: var(--text); border-bottom-color: var(--accent); }

    /* --- NEWS TICKER (STORY STYLE) --- */
    #newsSection {
      background: #111; border-bottom: 1px solid var(--border);
      padding: 15px 0; overflow-x: auto; white-space: nowrap;
      -webkit-overflow-scrolling: touch; /* iOS Smooth Scroll */
    }
    /* Hide Scrollbar */
    #newsSection::-webkit-scrollbar { display: none; }
    
    .news-container { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; gap: 12px; }
    
    .news-card {
      display: inline-flex; flex-direction: column; justify-content: center;
      background: var(--card); border: 1px solid var(--border);
      border-radius: 10px; padding: 12px 15px;
      min-width: 260px; max-width: 300px;
      position: relative; overflow: hidden;
      transition: transform 0.2s;
      white-space: normal; /* Text wrap inside card */
    }
    .news-card:active { transform: scale(0.98); }
    
    .nc-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
    .nc-badge { font-size: 10px; font-weight: 700; padding: 3px 6px; border-radius: 4px; text-transform: uppercase; color: #000; }
    .nc-date { font-size: 11px; color: var(--text-dim); }
    .nc-msg { font-size: 13px; line-height: 1.4; color: #eee; font-weight: 500; }
    
    /* News Type Colors */
    .type-restock { border-left: 4px solid var(--green); }
    .type-restock .nc-badge { background: var(--green); }
    
    .type-low { border-left: 4px solid var(--orange); }
    .type-low .nc-badge { background: var(--orange); }
    
    .type-new { border-left: 4px solid var(--blue); }
    .type-new .nc-badge { background: var(--blue); color: #fff; }
    
    .type-soldout { border-left: 4px solid var(--red); opacity: 0.7; }
    .type-soldout .nc-badge { background: var(--red); color: #fff;}

    /* --- CONTAINER --- */
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

    /* --- SEARCH & FILTERS --- */
    .top-bar { 
      display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 30px; 
    }
    @media (max-width: 768px) { .top-bar { grid-template-columns: 1fr; } }

    .input-group { position: relative; }
    .input-label { font-size: 11px; color: var(--text-dim); font-weight: 700; margin-bottom: 8px; display: block; letter-spacing: 0.5px; }
    
    .search-input, .custom-select {
      width: 100%; background: var(--card); border: 1px solid var(--border); color: #fff;
      padding: 14px 16px; border-radius: 10px; font-size: 16px; /* iOS zoom fix */
      transition: 0.2s; appearance: none;
    }
    .search-input:focus, .custom-select:focus { outline: none; border-color: var(--accent); ring: 1px solid var(--accent); }
    
    /* Search Results Dropdown */
    .search-results {
      position: absolute; top: 100%; left: 0; right: 0;
      background: #222; border: 1px solid var(--border); border-radius: 10px;
      max-height: 60vh; overflow-y: auto; z-index: 50; margin-top: 5px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: none;
    }
    .search-results.show { display: block; }
    .result-item { padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .result-item:last-child { border-bottom: none; }
    .result-item:hover { background: var(--hover); }
    .ri-name { font-weight: 500; }
    .ri-date { font-size: 12px; color: var(--accent); background: rgba(250, 204, 21, 0.1); padding: 3px 8px; border-radius: 100px; }

    /* --- EMPTY STATE --- */
    #emptyState { text-align: center; padding: 60px 20px; opacity: 0.5; }
    .empty-icon { font-size: 48px; margin-bottom: 20px; display: block; filter: grayscale(100%); }
    .empty-text { font-size: 18px; font-weight: 500; }

    /* --- DASHBOARD --- */
    .selected-event-header {
      background: var(--card); border: 1px solid var(--border); padding: 20px; 
      border-radius: 12px; margin-bottom: 20px; 
      display: flex; flex-direction: column; gap: 15px;
    }
    @media(min-width: 768px) { 
      .selected-event-header { flex-direction: row; align-items: center; justify-content: space-between; } 
    }

    .seh-title { font-size: 28px; font-family: var(--font-heading); color: var(--text); line-height: 1; }
    .seh-date { font-size: 14px; color: var(--text-dim); display: flex; align-items: center; gap: 6px; margin-top: 5px; }
    
    .shop-btn {
      background: var(--accent); color: #000; text-decoration: none;
      padding: 12px 24px; border-radius: 8px; font-weight: 700; font-size: 14px;
      display: inline-block; text-align: center; transition: 0.2s;
    }
    .shop-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(250, 204, 21, 0.3); }

    /* CHARTS */
    .chart-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    @media(min-width: 1000px) { .chart-grid { grid-template-columns: 1fr 1fr; } }

    .chart-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
    .chart-title { font-size: 15px; font-weight: 700; margin-bottom: 15px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
    .chart-box { position: relative; height: 300px; width: 100%; }

    /* --- UTILS --- */
    .hidden { display: none !important; }
    .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s infinite; margin: 40px auto; }
    @keyframes spin { to { transform: rotate(360deg); } }

  </style>
</head>
<body>

<header>
  <div class="header-top">
    <div class="brand">HYROX <span>RADAR</span> <span class="version">v4.5</span></div>
  </div>
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('tab-event')">City Analysis</button>
    <button class="tab-btn" onclick="switchTab('tab-category')">Global Search</button>
  </div>
</header>

<div id="newsSection">
    <div class="news-container" id="newsContainer">
        <div style="padding: 10px; color: #444; font-size: 14px;">Loading market updates...</div>
    </div>
</div>

<div class="container">

  <div id="tab-event" class="tab-content">
    
    <div class="top-bar">
      <div class="input-group">
        <label class="input-label">SEARCH CITY</label>
        <input type="text" id="eventSearch" class="search-input" placeholder="Type a city (e.g. London)..." autocomplete="off">
        <div id="searchResults" class="search-results"></div>
      </div>

      <div class="input-group">
        <label class="input-label">FILTER CATEGORY</label>
        <select id="eventFilterSelect" class="custom-select" onchange="setEventFilter(this.value)" disabled>
            <option value="ALL">Show All Categories</option>
            <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
            <option value="MEN_OPEN">Men Open</option>
            <option value="MEN_PRO">Men Pro</option>
            <option value="WOMEN_OPEN">Women Open</option>
            <option value="WOMEN_PRO">Women Pro</option>
            <option value="DOUBLES_MEN">Doubles Men</option>
            <option value="DOUBLES_WOMEN">Doubles Women</option>
            <option value="DOUBLES_MIXED">Doubles Mixed</option>
        </select>
      </div>
    </div>

    <div id="emptyState">
      <div class="empty-icon">üèôÔ∏è</div>
      <div class="empty-text">Select a city above to view stock analysis</div>
    </div>

    <div id="eventLoader" class="hidden"><div class="spinner"></div></div>

    <div id="eventDashboard" class="hidden">
      
      <div class="selected-event-header">
        <div>
          <div class="seh-title" id="sehName">Event Name</div>
          <div class="seh-date">
            üìÖ <span id="sehDate">...</span>
          </div>
        </div>
        <a href="#" id="sehLink" target="_blank" class="shop-btn">GO TO TICKET STORE ‚Üó</a>
      </div>

      <div class="chart-grid">
        <div class="chart-card">
          <div class="chart-title">üìà 7-Day Stock Trend</div>
          <div class="chart-box"><canvas id="chartHistory"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">üìä Real-Time Availability</div>
          <div class="chart-box"><canvas id="chartCurrent"></canvas></div>
        </div>
      </div>

    </div>
  </div>

  <div id="tab-category" class="tab-content hidden">
    <div class="chart-card">
        <div class="chart-title" style="margin-bottom: 10px;">FIND TICKETS GLOBALLY</div>
        <select id="categorySelector" class="custom-select" onchange="loadGlobalData()">
             <option disabled selected>Select category to scan world...</option>
        </select>
        <div id="globalLoader" class="hidden"><div class="spinner"></div></div>
        <div id="globalResults" style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;"></div>
    </div>
  </div>

</div>

<script>
/* --- CONFIG & STATE --- */
const CONFIG = {
  eventsFile: "events.json",
  categoriesFile: "yaristurleri.json",
  newsFile: "notifications.json",
  dataDir: "data"
};

let EVENTS = [];
let CATEGORIES = [];
let EVENT_DATA = null;
let EVENT_FILTER = 'ALL';
let CHARTS = { history: null, current: null };

/* --- INIT --- */
async function init() {
  try {
    const [evRes, catRes] = await Promise.all([
      fetch(`${CONFIG.eventsFile}?t=${Date.now()}`),
      fetch(`${CONFIG.categoriesFile}?t=${Date.now()}`)
    ]);

    if(evRes.ok) EVENTS = await evRes.json();
    if(catRes.ok) CATEGORIES = await catRes.json();

    // Sort Events by Date
    EVENTS.sort((a, b) => parseDate(a.startDate) - parseDate(b.startDate));

    setupSearch();
    populateCategoryDropdown();
    loadNotifications(); // Load News Ticker

  } catch (e) {
    console.error("Init Error", e);
  }
}

/* --- NEWS SYSTEM --- */
async function loadNotifications() {
    const container = document.getElementById('newsContainer');
    try {
        const res = await fetch(`${CONFIG.newsFile}?t=${Date.now()}`);
        if(!res.ok) throw new Error("No news");
        const news = await res.json();

        if(news.length === 0) {
            container.innerHTML = '<div style="padding:10px; color:#666;">No recent updates. Market is quiet.</div>';
            return;
        }

        container.innerHTML = ''; // Clear loading text

        news.forEach(item => {
            const card = document.createElement('div');
            
            // Determine Style
            let typeClass = 'type-new';
            let badgeText = 'NEW';
            if(item.type === 'restock') { typeClass = 'type-restock'; badgeText = 'RESTOCK'; }
            if(item.type === 'low_stock') { typeClass = 'type-low'; badgeText = 'LOW STOCK'; }
            if(item.type === 'soldout') { typeClass = 'type-soldout'; badgeText = 'SOLD OUT'; }
            
            // Format Date (Today/Yesterday)
            const timeStr = getRelativeTime(item.date);

            card.className = `news-card ${typeClass}`;
            card.innerHTML = `
                <div class="nc-header">
                    <span class="nc-badge">${badgeText}</span>
                    <span class="nc-date">${timeStr}</span>
                </div>
                <div class="nc-msg">${item.message}</div>
            `;
            container.appendChild(card);
        });

    } catch(e) {
        container.innerHTML = '';
        document.getElementById('newsSection').style.display = 'none';
    }
}

function getRelativeTime(dateStr) {
    const date = new Date(dateStr);
    const today = new Date();
    const diffTime = Math.abs(today - date);
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 
    
    // Check if it's the same calendar day (more precise than 24h)
    const isSameDay = date.getDate() === today.getDate() && 
                      date.getMonth() === today.getMonth();
    
    if (isSameDay) return 'TODAY';
    if (diffDays === 1) return 'YESTERDAY';
    if (diffDays < 7) return `${diffDays} DAYS AGO`;
    return dateStr.substring(5).replace('-','/'); // 02/15 style
}


/* --- EVENT SELECTION LOGIC --- */
function setupSearch() {
  const input = document.getElementById('eventSearch');
  const resultsBox = document.getElementById('searchResults');

  const renderList = (list) => {
    resultsBox.innerHTML = '';
    if(list.length === 0) {
      resultsBox.innerHTML = '<div style="padding:15px; color:#666; text-align:center;">No city found.</div>';
      return;
    }
    list.forEach(evt => {
      const div = document.createElement('div');
      div.className = 'result-item';
      div.innerHTML = `
        <span class="ri-name">${evt.name}</span>
        <span class="ri-date">${evt.startDate || 'TBA'}</span>
      `;
      div.onclick = () => {
        selectEvent(evt);
        input.value = evt.name;
        resultsBox.classList.remove('show');
      };
      resultsBox.appendChild(div);
    });
  };

  input.addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    const filtered = EVENTS.filter(evt => evt.name.toLowerCase().includes(term));
    renderList(filtered);
    resultsBox.classList.add('show');
  });

  input.addEventListener('focus', () => {
    renderList(EVENTS); 
    resultsBox.classList.add('show');
  });

  // Close when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.input-group')) {
      resultsBox.classList.remove('show');
    }
  });
}

function selectEvent(evt) {
  // UI Updates
  document.getElementById('emptyState').classList.add('hidden');
  document.getElementById('eventDashboard').classList.add('hidden'); // Hide momentarily
  document.getElementById('eventLoader').classList.remove('hidden');
  document.getElementById('eventFilterSelect').disabled = false;

  // Set Info
  document.getElementById('sehName').textContent = evt.name;
  document.getElementById('sehDate').textContent = evt.startDate || 'Date TBA';
  document.getElementById('sehLink').href = evt.url;

  // Reset Filter
  document.getElementById('eventFilterSelect').value = 'ALL';
  EVENT_FILTER = 'ALL';

  loadEventData(evt.id);
}

/* --- DATA LOADING & CHARTS --- */
async function loadEventData(eventId) {
    try {
        const res = await fetch(`${CONFIG.dataDir}/${eventId}.json?t=${Date.now()}`);
        if(!res.ok) throw new Error("Data missing");
        const json = await res.json();

        // Process Data
        EVENT_DATA = json.history.map(h => ({
            date: h.date,
            tickets: h.data.tickets.filter(t => !isExcluded(t.ticket))
        })).sort((a,b) => new Date(a.date) - new Date(b.date));

        // Render
        document.getElementById('eventLoader').classList.add('hidden');
        document.getElementById('eventDashboard').classList.remove('hidden');
        renderEventCharts();

    } catch (e) {
        document.getElementById('eventLoader').classList.add('hidden');
        alert("Sorry, data analysis for this event is not ready yet.");
    }
}

function isExcluded(ticketName) {
    const n = ticketName.toUpperCase();
    return n.includes('RELAY') || n.includes('CHARITY') || n.includes('SPECTATOR');
}

window.setEventFilter = (val) => {
    EVENT_FILTER = val;
    renderEventCharts();
}

function renderEventCharts() {
    if(!EVENT_DATA) return;
    
    // --- Logic copied from previous chat, simplified for brevity ---
    const ctxH = document.getElementById('chartHistory').getContext('2d');
    const labels = EVENT_DATA.map(d => d.date.substring(5).replace('-','.')); 

    // Filters Logic
    const filters = {
        'ALL': () => true,
        'MEN_OPEN': (n) => n.includes('MEN') && !n.includes('WOMEN') && !n.includes('PRO') && !n.includes('DOUBLES'),
        'MEN_PRO': (n) => n.includes('MEN') && !n.includes('WOMEN') && n.includes('PRO'),
        'WOMEN_OPEN': (n) => n.includes('WOMEN') && !n.includes('PRO') && !n.includes('DOUBLES'),
        'WOMEN_PRO': (n) => n.includes('WOMEN') && n.includes('PRO'),
        'DOUBLES_MEN': (n) => n.includes('DOUBLES') && n.includes('MEN') && !n.includes('WOMEN') && !n.includes('MIXED'),
        'DOUBLES_WOMEN': (n) => n.includes('DOUBLES') && n.includes('WOMEN') && !n.includes('MIXED'),
        'DOUBLES_MIXED': (n) => n.includes('DOUBLES') && n.includes('MIXED')
    };
    const check = filters[EVENT_FILTER] || filters['ALL'];

    // DATASET PREP (Aggregated for ALL, Specific for others)
    let datasets = [];
    if(EVENT_FILTER === 'ALL') {
        const groups = [
            { name: 'Men Open', c: '#3b82f6', r: filters['MEN_OPEN'] },
            { name: 'Women Open', c: '#ec4899', r: filters['WOMEN_OPEN'] },
            { name: 'Dbl Men', c: '#eab308', r: filters['DOUBLES_MEN'] },
            { name: 'Dbl Women', c: '#f97316', r: filters['DOUBLES_WOMEN'] },
            { name: 'Dbl Mixed', c: '#a855f7', r: filters['DOUBLES_MIXED'] }
        ];
        datasets = groups.map(g => ({
            label: g.name, borderColor: g.c, backgroundColor: g.c, tension:0.4, pointRadius:0, borderWidth:2,
            data: EVENT_DATA.map(day => day.tickets.filter(t => g.r(t.ticket.toUpperCase())).reduce((s,t)=>s+t.stock,0))
        }));
    } else {
        // Individual Lines
        const unique = new Set();
        EVENT_DATA.forEach(d => d.tickets.forEach(t => { if(check(t.ticket.toUpperCase())) unique.add(t.ticket); }));
        const colors = ['#facc15', '#3b82f6', '#ef4444', '#10b981'];
        let i=0;
        unique.forEach(u => {
             datasets.push({
                 label: u.replace(/HYROX /gi,'').trim(),
                 borderColor: colors[i++%colors.length], tension:0.4, pointRadius:2,
                 data: EVENT_DATA.map(d => { const f=d.tickets.find(x=>x.ticket===u); return f?f.stock:null; })
             });
        });
    }

    if(CHARTS.history) CHARTS.history.destroy();
    CHARTS.history = new Chart(ctxH, {
        type: 'line', data: { labels, datasets },
        options: { responsive:true, maintainAspectRatio:false, interaction:{mode:'index', intersect:false}, 
        scales:{ y:{beginAtZero:true, grid:{color:'#333'}}, x:{grid:{display:false}} },
        plugins:{ legend:{labels:{color:'#fff', boxWidth:10}} } }
    });

    // BAR CHART (Current)
    const latest = EVENT_DATA[EVENT_DATA.length-1];
    const currentItems = latest.tickets.filter(t => check(t.ticket.toUpperCase())).sort((a,b)=>b.stock-a.stock);
    
    const ctxC = document.getElementById('chartCurrent').getContext('2d');
    if(CHARTS.current) CHARTS.current.destroy();
    CHARTS.current = new Chart(ctxC, {
        type: 'bar',
        data: {
            labels: currentItems.map(t => t.ticket.replace(/HYROX /gi,'').trim()),
            datasets: [{ label:'Stock', data: currentItems.map(t=>t.stock), backgroundColor: currentItems.map(t=>t.stock<10?'#ef4444':'#10b981') }]
        },
        options: { indexAxis:'y', responsive:true, maintainAspectRatio:false, scales:{x:{grid:{color:'#333'}}, y:{grid:{display:false}}} }
    });
}

// Helper: Tab Switching
window.switchTab = (id) => {
    document.querySelectorAll('.tab-content').forEach(e => e.classList.add('hidden'));
    document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
    document.getElementById(id).classList.remove('hidden');
    event.target.classList.add('active');
}

// Helper: Utils
function parseDate(str) { if(!str) return 0; const p=str.split('.'); return new Date(p[2],p[1]-1,p[0]); }
function populateCategoryDropdown() {
    const sel = document.getElementById('categorySelector');
    CATEGORIES.forEach(c => { const o=document.createElement('option'); o.value=c.id; o.textContent=c.name; sel.appendChild(o); });
}

// Global Category Logic (Simplified)
async function loadGlobalData() {
    const catId = document.getElementById('categorySelector').value;
    const catRule = CATEGORIES.find(c=>c.id===catId);
    if(!catRule) return;
    
    document.getElementById('globalLoader').classList.remove('hidden');
    const div = document.getElementById('globalResults');
    div.innerHTML = '';

    const promises = EVENTS.map(evt => fetch(`${CONFIG.dataDir}/${evt.id}.json?t=${Date.now()}`).then(r=>r.ok?r.json():null).then(d=>({evt, d})).catch(()=>({evt, d:null})));
    const res = await Promise.all(promises);
    
    let html = '';
    res.forEach(({evt, d}) => {
        if(!d || !d.history.length) return;
        const last = d.history[d.history.length-1];
        let stock = 0;
        last.data.tickets.forEach(t => {
            if(isExcluded(t.ticket)) return;
            const n = t.ticket.toUpperCase();
            if(catRule.include.every(x=>n.includes(x)) && !catRule.exclude.some(x=>n.includes(x))) stock += t.stock;
        });

        if(stock > 0) {
            html += `
            <a href="${evt.url}" target="_blank" style="text-decoration:none; color:#fff;">
                <div style="background:#18181b; padding:15px; border-radius:8px; border:1px solid #333; display:flex; justify-content:space-between; align-items:center;">
                    <div><div style="font-size:14px; font-weight:700;">${evt.name}</div><div style="font-size:12px; color:#888;">${evt.startDate}</div></div>
                    <div style="text-align:right;"><div style="font-size:10px; color:#aaa;">AVAIL</div><div style="font-size:18px; font-weight:700; color:${stock<20?'#ef4444':'#10b981'}">${stock}</div></div>
                </div>
            </a>`;
        }
    });
    
    document.getElementById('globalLoader').classList.add('hidden');
    div.innerHTML = html || '<div style="text-align:center; color:#666;">No tickets found globally.</div>';
}

init();
</script>
</body>
</html>
