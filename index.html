<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Hyrox Pro - Bilet Takip Sistemi</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #0f1115; --card: #161920; --border: #2a2f3a;
      --accent: #fbbf24; --text: #fff; --text-dim: #9ca3af;
      --red: #ef4444; --green: #10b981;
    }
    body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 60px; }

    header {
      background: #000; border-bottom: 2px solid var(--accent); padding: 15px 20px;
      display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50;
    }
    .brand { font-family: 'Teko', sans-serif; font-size: 28px; font-weight: 600; text-transform: uppercase; }
    .brand span { color: var(--accent); }
    
    /* Etkinlik Se√ßici Stili */
    #eventSelector {
      background: #1a1d23; color: #fff; border: 1px solid var(--border);
      padding: 8px 12px; border-radius: 6px; outline: none; font-family: 'Inter'; cursor: pointer;
    }
    #eventSelector:focus { border-color: var(--accent); }

    .status { font-size: 12px; color: var(--text-dim); background: #222; padding: 5px 10px; border-radius: 4px; }

    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

    #loader {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 60vh; text-align: center;
    }
    .spinner {
      width: 50px; height: 50px;
      border: 4px solid rgba(255,255,255,0.1);
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .hidden { display: none !important; }

    .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; background: var(--card); padding: 10px; border-radius: 8px; border:1px solid var(--border); }
    .btn {
      flex: 1; background: transparent; border: 1px solid var(--border); color: var(--text-dim); padding: 10px; border-radius: 6px;
      cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; white-space: nowrap;
    }
    .btn:hover { background: #222; color: #fff; }
    .btn.active { background: var(--accent); color: #000; border-color: var(--accent); opacity: 1; }

    .chart-section { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .chart-header { font-size: 16px; font-weight: 700; margin-bottom: 15px; display: flex; justify-content: space-between; }
    .chart-box { position: relative; height: 350px; width: 100%; }

    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; color: var(--text-dim); padding: 10px; border-bottom: 1px solid var(--border); text-transform: uppercase; font-size: 11px; }
    td { padding: 12px 10px; border-bottom: 1px solid var(--border); color: var(--text); }
    tr:last-child td { border-bottom: none; }
    
    .diff-badge { padding: 3px 8px; border-radius: 4px; font-weight: 600; font-size: 12px; }
    .diff-neg { background: rgba(239, 68, 68, 0.15); color: #fca5a5; }
    .diff-neutral { color: var(--text-dim); opacity: 0.5; }
    .stock-val { font-family: 'Teko', sans-serif; font-size: 18px; letter-spacing: 0.5px; }

    #errorLog { display:none; background: #3f1515; color: #ffadad; padding: 15px; border-radius: 8px; margin-top: 20px; }
  </style>
</head>
<body>

<header>
  <div class="brand">HYROX <span>PRO</span></div>
  <select id="eventSelector" onchange="changeEvent(this.value)">
      <option value="">Yarƒ±≈ü Se√ßiniz...</option>
  </select>
  <div class="status" id="dbStatus">Baƒülanƒ±yor...</div>
</header>

<div class="container">

  <div id="loader">
    <div class="spinner"></div>
    <div style="font-size: 20px; font-weight: 600; margin-bottom: 5px;">Veriler Analiz Ediliyor</div>
    <div style="color: var(--text-dim); font-size: 14px;">Se√ßilen Yarƒ±≈ü Verileri Taranƒ±yor...</div>
  </div>

  <div id="dashboardContent" class="hidden">
    
    <div class="controls">
      <button class="btn active" data-key="ALL" onclick="setFilter('ALL')">GENEL √ñZET</button>
      <button class="btn" data-key="MEN" onclick="setFilter('MEN')">ERKEK (SINGLES)</button>
      <button class="btn" data-key="WOMEN" onclick="setFilter('WOMEN')">KADIN (SINGLES)</button>
      <button class="btn" data-key="DOUBLES" onclick="setFilter('DOUBLES')">DOUBLE (HEPSƒ∞)</button>
    </div>

    <div class="chart-section">
      <div class="chart-header">
        <span>üìà Satƒ±≈ü Trendi (Zamanla Deƒüi≈üim)</span>
        <span style="font-size:12px; color:var(--text-dim); font-weight:400;">Grafik: <span id="chartModeLabel">Genel</span></span>
      </div>
      <div class="chart-box">
        <canvas id="chartHistory"></canvas>
      </div>
    </div>

    <div class="chart-section">
      <div class="chart-header">üìä G√ºncel Stok Adetleri</div>
      <div class="chart-box">
        <canvas id="chartCurrent"></canvas>
      </div>
    </div>

    <div class="chart-section">
      <div class="chart-header">üìã Detaylƒ± Deƒüi≈üim Raporu (Son 2 Veri)</div>
      <div class="table-container">
        <table id="diffTable">
          <thead>
            <tr>
              <th>Bilet Tipi</th>
              <th>√ñnceki</th>
              <th>G√ºncel</th>
              <th>Fark</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <div id="errorLog"></div>

</div>

<script>
/* --- CONFIG & STATE --- */
let CONFIG = { dataDir: "", startDate: "" };
let EVENTS = [];
let HISTORY = [];
let FILTER = 'ALL';
let charts = { history: null, current: null };

/* --- UTILS --- */
const pad = n => String(n).padStart(2, "0");
const strToDate = s => { 
    if(!s) return new Date();
    const [d,m,y] = s.split(".").map(Number); 
    return new Date(y, m-1, d); 
};
const dateToStr = d => `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`;
const shortDate = s => s.substring(0, 5); 

/* --- CORE LOGIC --- */

// 1. events.json'u y√ºkle ve men√ºy√º olu≈ütur
async function initApp() {
    try {
        const res = await fetch(`events.json?t=${Date.now()}`);
        if(!res.ok) throw new Error("events.json dosyasƒ± okunamadƒ±.");
        
        EVENTS = await res.json();
        const selector = document.getElementById("eventSelector");
        
        selector.innerHTML = ""; // Temizle
        EVENTS.forEach(ev => {
            const opt = document.createElement("option");
            opt.value = ev.id;
            opt.textContent = ev.name;
            selector.appendChild(opt);
        });

        // ƒ∞lk yarƒ±≈üƒ± varsayƒ±lan olarak y√ºkle
        if(EVENTS.length > 0) {
            selector.value = EVENTS[0].id;
            changeEvent(EVENTS[0].id);
        }
    } catch(err) {
        showError("Ba≈ülatma Hatasƒ±: " + err.message);
    }
}

// 2. Yarƒ±≈ü deƒüi≈üince verileri tekrar y√ºkle
async function changeEvent(eventId) {
    const ev = EVENTS.find(e => e.id === eventId);
    if(!ev) return;

    // Ayarlarƒ± g√ºncelle
    CONFIG.dataDir = `data/${ev.id}`;
    CONFIG.startDate = ev.startDate;

    // UI Reset
    document.getElementById("dashboardContent").classList.add("hidden");
    document.getElementById("loader").classList.remove("hidden");
    document.getElementById("errorLog").style.display = "none";
    document.getElementById("dbStatus").textContent = "Y√ºkleniyor...";

    try {
        await loadAllData();
        document.getElementById("loader").classList.add("hidden");
        document.getElementById("dashboardContent").classList.remove("hidden");
        setFilter('ALL'); 
    } catch(err) {
        showError(err.message);
    }
}

async function loadAllData() {
    const start = strToDate(CONFIG.startDate);
    const now = new Date(); 
    const validData = [];
    
    let curr = new Date(start);
    let safety = 0;
    
    // Bug√ºnden 1 g√ºn sonrasƒ±na kadar tara (saat farklarƒ± i√ßin)
    const endLimit = new Date(now.getTime() + 86400000);

    while(curr <= endLimit && safety < 500) {
        const dStr = dateToStr(curr);
        try {
            const res = await fetch(`${CONFIG.dataDir}/${dStr}.json?t=${Date.now()}`);
            if(res.ok) {
                const json = await res.json();
                if(json.tickets) {
                    validData.push({
                        date: dStr,
                        timestamp: curr.getTime(),
                        tickets: processTickets(json.tickets)
                    });
                }
            }
        } catch(e) {}
        
        curr.setDate(curr.getDate() + 1);
        safety++;
    }

    if(!validData.length) {
        throw new Error(`'${CONFIG.dataDir}' klas√∂r√ºnde ge√ßerli JSON verisi bulunamadƒ±. L√ºtfen Python scriptinin √ßalƒ±≈ütƒ±ƒüƒ±ndan emin olun.`);
    }

    HISTORY = validData.sort((a,b) => a.timestamp - b.timestamp);
    
    document.getElementById("dbStatus").textContent = 
        `Veri Aralƒ±ƒüƒ±: ${HISTORY[0].date} - ${HISTORY[HISTORY.length-1].date}`;
}

function processTickets(list) {
    const filteredList = list.filter(t => !t.ticket.toUpperCase().includes("ADAPTIVE"));

    return filteredList.map(t => {
        let tags = [];
        const n = t.ticket.toUpperCase();
        
        if (n.includes("DOUBLES")) {
            tags.push("DOUBLES");
        } else if (n.includes("WOMEN")) {
            tags.push("WOMEN");
        } else if (n.includes("MEN")) {
            tags.push("MEN");
        }
        
        let cleanName = t.ticket.replace("HYROX ", "");
        return { id: t.ticket, name: cleanName, stock: t.stock, tags };
    });
}

/* --- UI ACTIONS --- */
window.setFilter = (f) => {
    FILTER = f;
    document.querySelectorAll(".btn").forEach(b => {
        if (b.getAttribute('data-key') === f) b.classList.add("active");
        else b.classList.remove("active");
    });
    updateHistoryChart();
    updateCurrentChart();
    updateTable();
};

/* --- CHARTS --- */
function updateHistoryChart() {
    const ctx = document.getElementById("chartHistory").getContext("2d");
    const labels = HISTORY.map(h => shortDate(h.date));
    let datasets = [];
    const modeLabel = document.getElementById("chartModeLabel");

    if(FILTER === 'ALL') {
        modeLabel.textContent = "Kategori Toplamlarƒ±";
        const groups = ['MEN', 'WOMEN', 'DOUBLES'];
        const colors = ['#3b82f6', '#ec4899', '#fbbf24']; 
        
        datasets = groups.map((g, i) => {
            return {
                label: g,
                data: HISTORY.map(day => {
                    return day.tickets.filter(t => t.tags.includes(g)).reduce((s, t) => s + t.stock, 0);
                }),
                borderColor: colors[i],
                backgroundColor: colors[i],
                tension: 0.3, borderWidth: 2
            };
        });
    } else {
        modeLabel.textContent = FILTER + " Detaylarƒ±";
        const ticketNames = new Set();
        HISTORY.forEach(day => {
            day.tickets.filter(t => t.tags.includes(FILTER)).forEach(t => ticketNames.add(t.name));
        });

        const palette = ['#fbbf24', '#3b82f6', '#ef4444', '#10b981', '#f97316', '#8b5cf6'];
        let colorIdx = 0;
        ticketNames.forEach(name => {
            const dataPoints = HISTORY.map(day => {
                const found = day.tickets.find(t => t.name === name);
                return found ? found.stock : null;
            });
            if(dataPoints.some(x => x !== null)) {
                datasets.push({
                    label: name,
                    data: dataPoints,
                    borderColor: palette[colorIdx % palette.length],
                    backgroundColor: palette[colorIdx % palette.length],
                    tension: 0.2, borderWidth: 2, pointRadius: 4
                });
                colorIdx++;
            }
        });
    }
    if(charts.history) charts.history.destroy();
    charts.history = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { labels: { color: '#9ca3af' } },
                tooltip: { backgroundColor: '#161920', titleColor: '#fff', bodyColor:'#ddd', borderColor:'#333', borderWidth:1 }
            },
            scales: {
                x: { grid: { color: '#2a2f3a' }, ticks: { color: '#9ca3af' } },
                y: { grid: { color: '#2a2f3a' }, ticks: { color: '#9ca3af' } }
            }
        }
    });
}

function updateCurrentChart() {
    const ctx = document.getElementById("chartCurrent").getContext("2d");
    const latest = HISTORY[HISTORY.length - 1];
    let data = latest.tickets;
    if(FILTER !== 'ALL') data = data.filter(t => t.tags.includes(FILTER));
    data.sort((a,b) => b.stock - a.stock);

    if(charts.current) charts.current.destroy();
    charts.current = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(t => t.name),
            datasets: [{
                label: 'Adet',
                data: data.map(t => t.stock),
                backgroundColor: data.map(t => t.stock < 50 ? '#ef4444' : '#10b981'),
                borderRadius: 4
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false, indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { color: '#2a2f3a' }, ticks: { color: '#9ca3af' } },
                y: { grid: { display:false }, ticks: { color: '#fff', font:{size:11} } }
            }
        }
    });
}

function updateTable() {
    const tbody = document.querySelector("#diffTable tbody");
    tbody.innerHTML = "";
    if(HISTORY.length < 1) return;
    const currentDay = HISTORY[HISTORY.length - 1];
    const prevDay = HISTORY.length > 1 ? HISTORY[HISTORY.length - 2] : null;
    let items = currentDay.tickets;
    if(FILTER !== 'ALL') items = items.filter(t => t.tags.includes(FILTER));
    items.sort((a,b) => b.stock - a.stock);
    items.forEach(curr => {
        let prevStock = "-";
        let diff = 0;
        if(prevDay) {
            const p = prevDay.tickets.find(x => x.name === curr.name);
            if(p) { prevStock = p.stock; diff = curr.stock - p.stock; }
        }
        const tr = document.createElement("tr");
        let diffHtml = `<span class="diff-badge diff-neutral">0</span>`;
        if(diff < 0) diffHtml = `<span class="diff-badge diff-neg">üîª ${Math.abs(diff)}</span>`;
        if(diff > 0) diffHtml = `<span class="diff-badge" style="color:#10b981">‚¨ÜÔ∏è +${diff}</span>`;
        tr.innerHTML = `<td>${curr.name}</td><td class="stock-val" style="color:#9ca3af">${prevStock}</td><td class="stock-val" style="color:#fff">${curr.stock}</td><td>${diffHtml}</td>`;
        tbody.appendChild(tr);
    });
}

function showError(msg) {
    document.getElementById("loader").classList.add("hidden");
    const el = document.getElementById("errorLog");
    el.style.display = "block";
    el.innerHTML = `<strong>HATA:</strong> ${msg}`;
}

// Uygulamayƒ± ba≈ülat
initApp();
</script>
</body>
</html>
