<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Hyrox Bilet Takip Paneli</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;600&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #0f1115; --card: #161920; --border: #2a2f3a;
      --accent: #fbbf24; --text: #fff; --text-dim: #9ca3af;
      --red: #ef4444; --green: #10b981;
    }
    body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 60px; }

    /* HEADER & DROPDOWN */
    header {
      background: #000; border-bottom: 2px solid var(--accent); padding: 15px 20px;
      display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; 
      position: sticky; top: 0; z-index: 50; gap: 10px;
    }
    .brand { font-family: 'Teko', sans-serif; font-size: 28px; font-weight: 600; text-transform: uppercase; margin-right: 20px;}
    .brand span { color: var(--accent); }
    
    .header-controls { display: flex; align-items: center; gap: 10px; flex-grow: 1; justify-content: flex-end; }
    
    select.event-selector {
      background: #222; color: #fff; border: 1px solid var(--border); padding: 8px 12px;
      border-radius: 6px; font-family: 'Inter', sans-serif; font-size: 14px; cursor: pointer;
      max-width: 300px; width: 100%;
    }
    select.event-selector:focus { outline: none; border-color: var(--accent); }

    .status { font-size: 12px; color: var(--text-dim); background: #222; padding: 5px 10px; border-radius: 4px; white-space: nowrap;}

    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

    /* LOADER */
    #loader {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 60vh; text-align: center;
    }
    .spinner {
      width: 50px; height: 50px;
      border: 4px solid rgba(255,255,255,0.1);
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .hidden { display: none !important; }

    /* FILTERS */
    .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; background: var(--card); padding: 10px; border-radius: 8px; border:1px solid var(--border); }
    .btn {
      flex: 1; background: transparent; border: 1px solid var(--border); color: var(--text-dim); padding: 10px; border-radius: 6px;
      cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; white-space: nowrap;
    }
    .btn:hover { background: #222; color: #fff; }
    .btn.active { background: var(--accent); color: #000; border-color: var(--accent); opacity: 1; }

    .chart-section { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .chart-header { font-size: 16px; font-weight: 700; margin-bottom: 15px; display: flex; justify-content: space-between; }
    .chart-box { position: relative; height: 350px; width: 100%; }

    /* TABLE */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; color: var(--text-dim); padding: 10px; border-bottom: 1px solid var(--border); text-transform: uppercase; font-size: 11px; }
    td { padding: 12px 10px; border-bottom: 1px solid var(--border); color: var(--text); }
    tr:last-child td { border-bottom: none; }
    
    .diff-badge { padding: 3px 8px; border-radius: 4px; font-weight: 600; font-size: 12px; }
    .diff-neg { background: rgba(239, 68, 68, 0.15); color: #fca5a5; }
    .diff-neutral { color: var(--text-dim); opacity: 0.5; }
    .stock-val { font-family: 'Teko', sans-serif; font-size: 18px; letter-spacing: 0.5px; }

    #errorLog { display:none; background: #3f1515; color: #ffadad; padding: 15px; border-radius: 8px; margin-top: 20px; }
  </style>
</head>
<body>

<header>
  <div class="brand">HYROX <span>PRO</span></div>
  
  <div class="header-controls">
    <select id="eventSelector" class="event-selector" onchange="loadSelectedEvent()">
      <option value="" disabled selected>Yarƒ±≈ü Y√ºkleniyor...</option>
    </select>
    <div class="status" id="dbStatus">Hazƒ±r</div>
  </div>
</header>

<div class="container">

  <div id="loader">
    <div class="spinner"></div>
    <div style="font-size: 20px; font-weight: 600; margin-bottom: 5px;">Veriler Analiz Ediliyor</div>
    <div style="color: var(--text-dim); font-size: 14px;">L√ºtfen bekleyin...</div>
  </div>

  <div id="dashboardContent" class="hidden">
    
    <div class="controls">
      <button class="btn active" data-key="ALL" onclick="setFilter('ALL')">GENEL √ñZET</button>
      <button class="btn" data-key="MEN" onclick="setFilter('MEN')">ERKEK (SINGLES)</button>
      <button class="btn" data-key="WOMEN" onclick="setFilter('WOMEN')">KADIN (SINGLES)</button>
      <button class="btn" data-key="DOUBLES" onclick="setFilter('DOUBLES')">DOUBLE (HEPSƒ∞)</button>
    </div>

    <div class="chart-section">
      <div class="chart-header">
        <span>üìà Satƒ±≈ü Trendi (Zamanla Deƒüi≈üim)</span>
        <span style="font-size:12px; color:var(--text-dim); font-weight:400;">Grafik: <span id="chartModeLabel">Genel</span></span>
      </div>
      <div class="chart-box">
        <canvas id="chartHistory"></canvas>
      </div>
    </div>

    <div class="chart-section">
      <div class="chart-header">üìä G√ºncel Stok Adetleri</div>
      <div class="chart-box">
        <canvas id="chartCurrent"></canvas>
      </div>
    </div>

    <div class="chart-section">
      <div class="chart-header">üìã Detaylƒ± Deƒüi≈üim Raporu (Son 2 Veri)</div>
      <div class="table-container">
        <table id="diffTable">
          <thead>
            <tr>
              <th>Bilet Tipi</th>
              <th>√ñnceki</th>
              <th>G√ºncel</th>
              <th>Fark</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <div id="errorLog"></div>

</div>

<script>
/* --- YAPILANDIRMA --- */
const CONFIG = { 
  eventsFile: "events.json",
  dataDir: "data" 
};

let HISTORY = []; // Se√ßili yarƒ±≈üƒ±n tarih√ßesi buraya y√ºklenecek
let EVENTS = [];  // T√ºm yarƒ±≈ülarƒ±n listesi
let FILTER = 'ALL';
let charts = { history: null, current: null };

/* --- YARDIMCI FONKSƒ∞YONLAR --- */
const shortDate = s => {
  if(!s) return "-";
  // s formatƒ±: 2026-02-07
  const parts = s.split("-");
  return `${parts[2]}.${parts[1]}`; // √áƒ±ktƒ±: 07.02
};

/* --- ANA AKI≈û --- */

// 1. Sayfa a√ßƒ±ldƒ±ƒüƒ±nda events.json'ƒ± y√ºkle
async function init() {
  try {
    const res = await fetch(`${CONFIG.eventsFile}?t=${Date.now()}`);
    if(!res.ok) throw new Error("events.json dosyasƒ± bulunamadƒ±.");
    
    EVENTS = await res.json();
    
    const selector = document.getElementById("eventSelector");
    selector.innerHTML = '<option value="" disabled>Bir Yarƒ±≈ü Se√ßin</option>';
    
    EVENTS.forEach((evt, index) => {
      const opt = document.createElement("option");
      opt.value = evt.id;
      opt.textContent = evt.name || evt.id;
      selector.appendChild(opt);
    });

    // ƒ∞lk yarƒ±≈üƒ± otomatik se√ß
    if (EVENTS.length > 0) {
      selector.selectedIndex = 1; // ƒ∞lk opsiyon disabled olduƒüu i√ßin 1
      loadSelectedEvent();
    } else {
      showError("Listelenecek yarƒ±≈ü bulunamadƒ±.");
    }

  } catch (err) {
    showError("Ba≈ülangƒ±√ß hatasƒ±: " + err.message);
  }
}

// 2. Dropdown deƒüi≈üince √ßalƒ±≈üƒ±r
async function loadSelectedEvent() {
  const eventId = document.getElementById("eventSelector").value;
  if(!eventId) return;

  // UI Sƒ±fƒ±rla
  document.getElementById("loader").classList.remove("hidden");
  document.getElementById("dashboardContent").classList.add("hidden");
  document.getElementById("errorLog").style.display = "none";
  
  try {
    // data/{id}.json dosyasƒ±nƒ± √ßek
    const url = `${CONFIG.dataDir}/${eventId}.json?t=${Date.now()}`;
    const res = await fetch(url);
    
    if(!res.ok) throw new Error(`${eventId} i√ßin veri dosyasƒ± hen√ºz olu≈ümamƒ±≈ü.`);
    
    const json = await res.json();
    
    if (!json.history || json.history.length === 0) {
      throw new Error("Bu yarƒ±≈ü i√ßin ge√ßmi≈ü verisi bo≈ü.");
    }

    // Gelen veriyi i≈üle ve HISTORY deƒüi≈ükenine ata
    // Yeni JSON yapƒ±sƒ±: { history: [ { date: "...", data: { tickets: [...] } } ] }
    HISTORY = json.history.map(item => {
      return {
        date: item.date,
        tickets: processTickets(item.data.tickets)
      };
    });

    // Tarihe g√∂re sƒ±rala (Eskiden yeniye)
    HISTORY.sort((a, b) => new Date(a.date) - new Date(b.date));

    // UI G√ºncelle
    document.getElementById("dbStatus").textContent = `Son G√ºncelleme: ${HISTORY[HISTORY.length-1].date}`;
    document.getElementById("loader").classList.add("hidden");
    document.getElementById("dashboardContent").classList.remove("hidden");

    // Filtreleri ve grafikleri tetikle
    setFilter('ALL');

  } catch (err) {
    document.getElementById("loader").classList.add("hidden");
    showError(err.message);
  }
}

// Bilet verilerini temizle ve etiketle
function processTickets(list) {
  if(!list) return [];
  const filteredList = list.filter(t => !t.ticket.toUpperCase().includes("ADAPTIVE"));

  return filteredList.map(t => {
    let tags = [];
    const n = t.ticket.toUpperCase();
    
    if (n.includes("DOUBLES")) {
        tags.push("DOUBLES");
    } else if (n.includes("WOMEN")) {
        tags.push("WOMEN");
    } else if (n.includes("MEN")) {
        tags.push("MEN");
    }
    
    // "HYROX " kelimesini sil temiz g√∂r√ºns√ºn
    let cleanName = t.ticket.replace(/HYROX /gi, "").trim();
    return { id: t.ticket, name: cleanName, stock: t.stock, tags };
  });
}

function showError(msg) {
  const el = document.getElementById("errorLog");
  el.style.display = "block";
  el.innerHTML = `<strong>HATA:</strong> ${msg}`;
}

/* --- UI ACTIONS --- */
window.setFilter = (f) => {
  FILTER = f;
  document.querySelectorAll(".btn").forEach(b => {
    if (b.getAttribute('data-key') === f) b.classList.add("active");
    else b.classList.remove("active");
  });
  updateHistoryChart();
  updateCurrentChart();
  updateTable();
};

/* --- GRAFƒ∞KLER --- */
function updateHistoryChart() {
  const ctx = document.getElementById("chartHistory").getContext("2d");
  const labels = HISTORY.map(h => shortDate(h.date));
  let datasets = [];
  const modeLabel = document.getElementById("chartModeLabel");

  if(FILTER === 'ALL') {
    modeLabel.textContent = "Kategori Toplamlarƒ±";
    const groups = ['MEN', 'WOMEN', 'DOUBLES'];
    const colors = ['#3b82f6', '#ec4899', '#fbbf24']; 
    
    datasets = groups.map((g, i) => {
      return {
        label: g,
        data: HISTORY.map(day => {
          return day.tickets.filter(t => t.tags.includes(g)).reduce((s, t) => s + t.stock, 0);
        }),
        borderColor: colors[i],
        backgroundColor: colors[i],
        tension: 0.3, borderWidth: 2
      };
    });
  } else {
    modeLabel.textContent = FILTER + " Detaylarƒ±";
    // Se√ßili filtredeki t√ºm benzersiz bilet isimlerini bul
    const ticketNames = new Set();
    HISTORY.forEach(day => {
      day.tickets.filter(t => t.tags.includes(FILTER)).forEach(t => ticketNames.add(t.name));
    });

    const palette = ['#fbbf24', '#3b82f6', '#ef4444', '#10b981', '#f97316', '#8b5cf6', '#ddd'];
    let colorIdx = 0;
    
    ticketNames.forEach(name => {
      const dataPoints = HISTORY.map(day => {
        const found = day.tickets.find(t => t.name === name);
        return found ? found.stock : null; // Eƒüer o tarihte o bilet yoksa null
      });
      
      // Sadece verisi olanlarƒ± √ßiz
      if(dataPoints.some(x => x !== null)) {
        datasets.push({
          label: name,
          data: dataPoints,
          borderColor: palette[colorIdx % palette.length],
          backgroundColor: palette[colorIdx % palette.length],
          tension: 0.2, borderWidth: 2, pointRadius: 4
        });
        colorIdx++;
      }
    });
  }

  if(charts.history) charts.history.destroy();
  
  charts.history = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { labels: { color: '#9ca3af' } },
        tooltip: { backgroundColor: '#161920', titleColor: '#fff', bodyColor:'#ddd', borderColor:'#333', borderWidth:1 }
      },
      scales: {
        x: { grid: { color: '#2a2f3a' }, ticks: { color: '#9ca3af' } },
        y: { grid: { color: '#2a2f3a' }, ticks: { color: '#9ca3af' } }
      }
    }
  });
}

function updateCurrentChart() {
  const ctx = document.getElementById("chartCurrent").getContext("2d");
  const latest = HISTORY[HISTORY.length - 1]; // En son veri
  
  if (!latest) return;

  let data = latest.tickets;
  if(FILTER !== 'ALL') data = data.filter(t => t.tags.includes(FILTER));
  
  // Stok adedine g√∂re √ßoktan aza sƒ±rala
  data.sort((a,b) => b.stock - a.stock);

  if(charts.current) charts.current.destroy();
  
  charts.current = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: data.map(t => t.name),
      datasets: [{
        label: 'Adet',
        data: data.map(t => t.stock),
        backgroundColor: data.map(t => t.stock < 50 ? '#ef4444' : '#10b981'), // Az kaldƒ±ysa kƒ±rmƒ±zƒ±
        borderRadius: 4
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false, indexAxis: 'y',
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { color: '#2a2f3a' }, ticks: { color: '#9ca3af' } },
        y: { grid: { display:false }, ticks: { color: '#fff', font:{size:11} } }
      }
    }
  });
}

function updateTable() {
  const tbody = document.querySelector("#diffTable tbody");
  tbody.innerHTML = "";
  
  if(HISTORY.length < 1) return;
  
  const currentDay = HISTORY[HISTORY.length - 1];
  const prevDay = HISTORY.length > 1 ? HISTORY[HISTORY.length - 2] : null;
  
  let items = currentDay.tickets;
  if(FILTER !== 'ALL') items = items.filter(t => t.tags.includes(FILTER));
  
  items.sort((a,b) => b.stock - a.stock);
  
  items.forEach(curr => {
    let prevStock = "-";
    let diff = 0;
    
    if(prevDay) {
      const p = prevDay.tickets.find(x => x.name === curr.name);
      if(p) { prevStock = p.stock; diff = curr.stock - p.stock; }
    }
    
    const tr = document.createElement("tr");
    
    let diffHtml = `<span class="diff-badge diff-neutral">0</span>`;
    if(diff < 0) diffHtml = `<span class="diff-badge diff-neg">üîª ${Math.abs(diff)}</span>`; // Stok azalmasƒ± (Satƒ±≈ü)
    if(diff > 0) diffHtml = `<span class="diff-badge" style="color:#10b981">‚¨ÜÔ∏è +${diff}</span>`; // Stok artƒ±≈üƒ± (ƒ∞ade/Ekleme)
    
    tr.innerHTML = `
      <td>${curr.name}</td>
      <td class="stock-val" style="color:#9ca3af">${prevStock}</td>
      <td class="stock-val" style="color:#fff">${curr.stock}</td>
      <td>${diffHtml}</td>
    `;
    tbody.appendChild(tr);
  });
}

// Uygulamayƒ± ba≈ülat
init();

</script>
</body>
</html>
